<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Power-of-Two Inputs</title>
	<style>
		:root {
			--bg: #0f172a;
			--card: #111827;
			--accent: #38bdf8;
			--text: #e5e7eb;
			--muted: #94a3b8;
			--border: #1f2937;
		}

		* { box-sizing: border-box; }

		body {
			margin: 0;
			min-height: 100vh;
			display: grid;
			place-items: center;
			background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.12), transparent 25%),
									radial-gradient(circle at 80% 30%, rgba(59, 130, 246, 0.12), transparent 28%),
									linear-gradient(135deg, #0b1221 0%, #0f172a 100%);
			color: var(--text);
			font-family: "Space Grotesk", "Sora", "Manrope", system-ui, -apple-system, sans-serif;
			padding: 32px;
		}

		.card {
			width: min(880px, 100%);
			background: var(--card);
			border: 1px solid var(--border);
			border-radius: 18px;
			padding: 32px;
			box-shadow: 0 15px 45px rgba(0, 0, 0, 0.35);
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: baseline;
			gap: 12px;
			margin-bottom: 18px;
		}

		h1 {
			margin: 0;
			font-size: 1.6rem;
			letter-spacing: -0.03em;
		}

		p {
			margin: 0;
			color: var(--muted);
		}

		.slider-row {
			display: grid;
			grid-template-columns: 1fr auto;
			gap: 14px;
			align-items: center;
			margin: 18px 0 8px;
		}

		input[type="range"] {
			width: 100%;
			accent-color: var(--accent);
		}

		.value-pill {
			padding: 6px 12px;
			border-radius: 999px;
			background: rgba(56, 189, 248, 0.12);
			border: 1px solid var(--border);
			color: var(--accent);
			font-weight: 600;
			letter-spacing: 0.01em;
		}

		.inputs-grid {
			display: grid;
			grid-template-columns: repeat(4, minmax(0, 1fr));
			gap: 10px;
			margin-top: 14px;
		}

		.inputs-grid input[type="text"] {
			width: 100%;
			padding: 10px 12px;
			border-radius: 10px;
			border: 1px solid var(--border);
			background: #0c1323;
			color: var(--text);
			outline: none;
			transition: border-color 0.15s ease, box-shadow 0.15s ease;
		}

		.inputs-grid input[type="text"]:focus {
			border-color: var(--accent);
			box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15);
		}

		.hint {
			margin-top: 8px;
			color: var(--muted);
			font-size: 0.9rem;
		}

		#screenOverlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			background: black;
			opacity: 0;
			pointer-events: none;
			z-index: 9998;
		}

		#bgVideo {
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			object-fit: cover;
			background: black;
			opacity: 0;
			z-index: 9999;
			pointer-events: none;
		}
	</style>
</head>
<body>
	<main class="card">
		<div class="header">
			<div>
				<h1>Infinite PPAP</h1>
			</div>
		</div>

		<div class="slider-row">
			<input id="powerSlider" type="range" min="0" max="6" step="1" value="0" aria-label="Power of two selector" />
			<span class="value-pill" id="valuePill">1</span>
		</div>

		<section class="inputs-grid" id="inputsGrid"></section>
		<div style="display: grid; gap: 10px; margin-top: 16px; grid-template-columns: 1fr auto; align-items: end;">
			<label style="display: grid; gap: 6px; color: var(--muted); font-size: 0.9rem;">
				ElevenLabs API Key
				<input id="apiKey"  placeholder="sk_..." style="padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #0c1323; color: var(--text);" />
			</label>
			<button id="submitBtn" type="button" style="padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--accent); color: #0b1221; font-weight: 700; cursor: pointer;">Generate & Play</button>
		</div>
	</main>

	<div id="screenOverlay"></div>
	<video id="bgVideo" muted playsinline preload="metadata" src="video.mp4"></video>

	<script>
		const allowedValues = [1, 2, 4, 8, 16, 32, 64];
		const slider = document.getElementById('powerSlider');
		const valuePill = document.getElementById('valuePill');
		const inputsGrid = document.getElementById('inputsGrid');
		const submitBtn = document.getElementById('submitBtn');
		const apiKeyInput = document.getElementById('apiKey');
		const voiceIdInput = document.getElementById('voiceId');
		const backingTrack = new Audio('audio.mp3');
		const bgVideo = document.getElementById('bgVideo');
		const screenOverlay = document.getElementById('screenOverlay');
		const LOOP_START = 18.35;
		const LOOP_END = 38;
		const VIDEO_FADE_IN = 10.35;
		const VIDEO_LOOP_START = 16;
		const VIDEO_LOOP_END = 28;
		const SCREEN_FADE_DURATION = 1; // seconds
		const PRE_START_DELAY = 2; // seconds before audio/video start to begin screen fade

		const defaultVoice = '21m00Tcm4TlvDq8ikWAM'; // ElevenLabs default (Rachel)

		slider.max = allowedValues.length - 1;

		const renderInputs = (count) => {
			inputsGrid.innerHTML = '';
			for (let i = 0; i < count; i += 1) {
				const input = document.createElement('input');
				input.type = 'text';
				input.placeholder = `Box ${i + 1}`;
				inputsGrid.appendChild(input);
			}
		};

		const syncUI = (index) => {
			const value = allowedValues[index] ?? allowedValues[0];
			valuePill.textContent = value;
			renderInputs(value);
		};

		slider.addEventListener('input', () => {
			const index = Number(slider.value);
			syncUI(index);
		});

		const buildPPAPLyrics = (words) => {
			const clean = words.map((w) => w.trim()).filter(Boolean);

			// Ensure we have at least two items and pad to the next power of two.
			if (clean.length === 0) clean.push('pen', 'apple');
			if (clean.length === 1) clean.push(clean[0]);

			const target = (() => {
				let t = 1;
				while (t < clean.length) t *= 2;
				return Math.max(t, 2);
			})();
			while (clean.length < target) clean.push(clean[clean.length - 1]);

			const fmtRaw = (arr) => arr.join('-');
			const fmtOut = (arr) => {
				if (arr.length > 1 && arr.every((t) => t === arr[0])) {
					const parts = Array.from({ length: arr.length - 1 }, () => 'long');
					parts.push(arr[0]);
					return parts.join('-');
				}
				return fmtRaw(arr);
			};

			const swap = (arr) => {
				if (arr.length === 1) return arr;
				const half = arr.length / 2;
				const first = arr.slice(0, half);
				const second = arr.slice(half);
				// Per spec: swap(second) comes first, then the first half.
				return [...swap(second), ...first];
			};

			const lines = [];
			let current = clean.map((item) => [item]);

			while (current.length > 1) {
				const nextRound = [];
				for (let i = 0; i < current.length; i += 2) {
					const a = current[i];
					const b = current[i + 1];
                    if (a.length === 1) {
                        lines.push(`I have a ${fmtOut(a)}, I have a ${fmtOut(b)}.`);
                    } else {
                        lines.push(`${fmtOut(a)}, ${fmtOut(b)}.`);
                    }
					const combined = swap([...a, ...b]);
					lines.push(`Uh! ${fmtOut(combined)}!`);
					lines.push('');
					nextRound.push(combined);
				}
				current = nextRound;
			}

			lines.push(`${fmtOut(current[0])}!`);
			return lines.join('\n').replace(/\n$/, '');
		};

		const playAudioFromText = async (text) => {
			const apiKey = apiKeyInput.value.trim();
			const voiceId = 'pNInz6obpgDQGcFmaJgB';

			if (!apiKey) {
				alert('Please enter your ElevenLabs API key.');
				return;
			}

			submitBtn.disabled = true;
			submitBtn.textContent = 'Generating...';

			try {
				const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(voiceId)}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'xi-api-key': apiKey,
						Accept: 'audio/mpeg',
					},
					body: JSON.stringify({
						text,
						model_id: 'eleven_multilingual_v2',
					}),
				});

				if (!res.ok) {
					const msg = await res.text();
					throw new Error(`TTS failed: ${res.status} ${msg}`);
				}

				const blob = await res.blob();
				const url = URL.createObjectURL(blob);
				const ttsAudio = new Audio(url);

				let lyricsStarted = false;
				let ttsDone = false;
				let fadeOutStarted = false;
				let videoSeeking = false;
				let screenFadedOut = false;
				let fadeInId = null;
				let fadeOutId = null;
				let screenFadeId = null;
				let fadeOutDuration = null;
				let fadeOutStart = null;

				const teardown = () => {
					backingTrack.removeEventListener('timeupdate', onTimeUpdate);
					ttsAudio.removeEventListener('ended', onTtsEnded);
					bgVideo.removeEventListener('timeupdate', onVideoTimeUpdate);
					bgVideo.removeEventListener('ended', onVideoEnded);
					bgVideo.removeEventListener('seeked', onVideoSeeked);
					if (fadeInId) cancelAnimationFrame(fadeInId);
					if (fadeOutId) cancelAnimationFrame(fadeOutId);
					if (screenFadeId) cancelAnimationFrame(screenFadeId);
				};

				// Fade screen to black (cubic ease-in)
				const fadeScreenToBlack = (callback) => {
					const start = performance.now();
					const step = (now) => {
						const elapsed = (now - start) / 1000;
						const linear = Math.min(1, elapsed / SCREEN_FADE_DURATION);
						const progress = Math.pow(linear, 3);
						screenOverlay.style.opacity = progress.toFixed(3);
						if (linear < 1) {
							screenFadeId = requestAnimationFrame(step);
						} else {
							screenFadedOut = true;
							if (callback) callback();
						}
					};
					screenFadeId = requestAnimationFrame(step);
				};

				// Fade screen back in from black (cubic ease-out)
				const fadeScreenFromBlack = () => {
					const start = performance.now();
					const step = (now) => {
						const elapsed = (now - start) / 1000;
						const linear = Math.min(1, elapsed / SCREEN_FADE_DURATION);
						const progress = 1 - Math.pow(1 - linear, 3);
						screenOverlay.style.opacity = (1 - progress).toFixed(3);
						if (linear < 1) {
							screenFadeId = requestAnimationFrame(step);
						} else {
							screenOverlay.style.opacity = '0';
						}
					};
					screenFadeId = requestAnimationFrame(step);
				};

				const startFadeIn = () => {
					const start = performance.now();
					const step = (now) => {
						const elapsed = (now - start) / 1000;
						const linear = Math.min(1, elapsed / VIDEO_FADE_IN);
						// Exponential ease-in: slow start, fast finish
						const progress = Math.pow(linear, 3);
						bgVideo.style.opacity = progress.toFixed(3);
						if (progress < 1) {
							fadeInId = requestAnimationFrame(step);
						}
					};
					fadeInId = requestAnimationFrame(step);
				};

				const startFadeOut = () => {
					if (fadeOutStarted) return;
					fadeOutStarted = true;
					if (fadeOutId) cancelAnimationFrame(fadeOutId);
					const start = fadeOutStart ?? performance.now();
					const duration = fadeOutDuration ?? 1.5;
					const initialOpacity = parseFloat(bgVideo.style.opacity || '1');
					const step = (now) => {
						const elapsed = (now - start) / 1000;
						const progress = Math.min(1, elapsed / duration);
						const next = Math.max(0, initialOpacity * (1 - progress));
						bgVideo.style.opacity = next.toFixed(3);
						if (progress < 1) {
							fadeOutId = requestAnimationFrame(step);
						} else {
							bgVideo.pause();
							// Wait 1 second then fade screen back in
							setTimeout(() => {
								fadeScreenFromBlack();
							}, 1000);
						}
					};
					fadeOutId = requestAnimationFrame(step);
				};

				const onTtsEnded = () => {
					ttsDone = true;
					fadeOutStart = performance.now();
					const remaining = Math.max(0.1, LOOP_END - backingTrack.currentTime);
					fadeOutDuration = remaining;
					startFadeOut();
				};

				const onTimeUpdate = () => {
					if (!lyricsStarted && backingTrack.currentTime >= LOOP_START) {
						lyricsStarted = true;
						ttsAudio.play().catch((err) => {
							console.error(err);
						});
					}

					if (backingTrack.currentTime >= LOOP_END - 0.05) {
						if (ttsDone) {
							backingTrack.pause();
							teardown();
							startFadeOut();
						} else {
							backingTrack.currentTime = LOOP_START;
						}
					}
				};

				const onBackingStarted = () => {
					// Start screen fade to black immediately (1 second duration)
					// After 1 second (when screen is black), start video
					fadeScreenToBlack(() => {
						const startVideo = () => {
							bgVideo.currentTime = VIDEO_LOOP_START + 0.01;
							bgVideo.play().catch((err) => console.error(err));
							startFadeIn();
						};
						if (bgVideo.readyState >= 1) {
							startVideo();
						} else {
							bgVideo.load();
							bgVideo.addEventListener('loadedmetadata', startVideo, { once: true });
						}
					});
				};

				const loopVideo = () => {
					if (videoSeeking || fadeOutStarted) return;
					videoSeeking = true;
					bgVideo.currentTime = VIDEO_LOOP_START;
				};

				const onVideoSeeked = () => {
					videoSeeking = false;
					if (!fadeOutStarted && bgVideo.paused) {
						bgVideo.play().catch((err) => console.error(err));
					}
				};

				const onVideoTimeUpdate = () => {
					if (bgVideo.currentTime >= VIDEO_LOOP_END - 0.1) {
						loopVideo();
					}
				};

				const onVideoEnded = () => {
					loopVideo();
				};

				const startBacking = () => {
					// Start audio 2 seconds earlier to allow for screen fade before video starts
					backingTrack.currentTime = 8 - PRE_START_DELAY;
					backingTrack.addEventListener('timeupdate', onTimeUpdate);
					ttsAudio.addEventListener('ended', onTtsEnded);
					bgVideo.addEventListener('timeupdate', onVideoTimeUpdate);
					bgVideo.addEventListener('ended', onVideoEnded);
					bgVideo.addEventListener('seeked', onVideoSeeked);
					backingTrack.addEventListener('playing', onBackingStarted, { once: true });
					backingTrack.play().catch((err) => {
						console.error(err);
						teardown();
					});
				};

				if (backingTrack.readyState >= 1) {
					startBacking();
				} else {
					backingTrack.addEventListener('loadedmetadata', startBacking, { once: true });
				}

			} catch (err) {
				console.error(err);
				alert(err.message || 'Failed to generate audio.');
			} finally {
				submitBtn.disabled = false;
				submitBtn.textContent = 'Generate & Play';
			}
		};

		submitBtn.addEventListener('click', () => {
			const values = Array.from(inputsGrid.querySelectorAll('input')).map((input) => input.value);
			const lyrics = buildPPAPLyrics(values);
			console.log(`Script length: ${lyrics.length}`);
			console.log('Script contents:\n' + lyrics);
			playAudioFromText(lyrics);
		});

		// Initialize UI.
		syncUI(Number(slider.value));
	</script>
</body>
</html>
